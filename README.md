# **pkf_trackpoint-qt** v1.1.0
Qt application for configuring a TrackPoint

## Description
This program will allows you to change the speed, sensitivity, and press_to_select settings of the TrackPoint on ThinkPads running GNU/Linux ***(See "Limitations" below)***   

## Usage
### Modes
- Normal: Run program as root or by running it with "sudo" for use of all features
- ReadOnly: Run program as normal user to view current TrackPoint settings
- Test:  Run program pointing to a testing directory.  Allows normal users to test all functionality and allows root to use without changing any system settings     
*NOTE: All files generated by "Test" mode are deleted when the user exists the program*

### Operation
- To change one or more settings of the TrackPoint, enter the appropriate value in the text field and click "Apply".  Text fields left blank are ignored.
- To enable current settings to persist reboots, check the "Enable Persistence" checkbox
- To disable persistence (and remove any files created for persistence), un-check the "Enable Persistence" checkbox
- To reset the TrackPoint settings to default values, click "Defaults".  

## Limitations
All Limitations will be addressed in future versions
- Persistence currently only works for systemd

### Disclaimer...
This program was written by a novice who is just learning C++ and Qt.  As such, the author is aware that there is much room for improvement in the code and appreciates any suggestions for cleaning it up or making it more efficient.  The author can be reached at "afogl001@members.fsf.org".    

### Planned Improvements
- Allow Evdev users to choose wither to initiate scrolling 
- Fix minor offset of labels
- Do now allow user to un-check persist if not root
- Add initd support for persistence
- Allow user to run and prompt for escalated privileges
- Add menu items for "Close", "Help", and "About".
- Clean up code by
  - Making better use of functions and parameters (e.x., make "install" functions uninstall as well)
  - Leverage variables to reduce repetitious text/values
  - Find better way of creating persistence files (instead of just streaming line-by-line)
  - Consider breaking out some code from main and put in other classes
- Create binaries
- Create .deb and .rpm packages

### **Code overview**
#### Functions
+ setSettingsPath() = Sets path for TrackPoint settings (aka, speed, sensitivity, and press_to_select)
  - Runs directory iterator loop to determine correct TrackPoint settings path (starts with default value of  *testPath*)
  - If no paths match those tested, show alert window and run **setTestMode** with "1", putting the user in "Test" mode.
+ applySettings(QString settingsFile, QString settingsValue) = Applies any specified TrackPoint setting
  - If *settingsValue* not NULL, applies that value to the *settingsFile*
+ validateSettings() = Configure validators for text edit boxes
  - Create QValidators for values "1-255" and "0-1"
  - Set speed and sensitivity edit texts boxes with "1-255" validator
  - set press_to_select edit text box to "0-1" validator
+ displaySettings() = Displays current TrackPoint setting values
  - Checks existence of a "speed" file, throwing warning error to user if it doesn't exist or passing value to appropriate label if it does
  - Checks existence of a "sensitivity" file, throwing warning error to user if it doesn't exist or passing value to appropriate label if it does
  - Checks existence of a "press_to_select" file, throwing warning error to user if it doesn't exist or passing value to appropriate label if it does
+ setPersistPaths() = Sets path for initialization settings, used for configuring persistent TrackPoint settings
  - Runs conditional to determine what path to use based on existence (starts with default value of *testPath*) and sets values as follows...
    - If "speed" file exist in "/tmp/pkf_trackpoint", set *trackpointSHPath* and *initPath* to "/tmp/pkf_trackpoint"
    - If "/etc/systemd/system" exist (systemd), set *trackpointSHPath* to "/usr/bin" and *initPath* to "/etc/systemd/system"
    - If no paths match, set *trackpointSHPath* and *initPath* to "N/A"
  - Run conditional to check existence of persistent script ("trackpoint.sh"), checking the persist checkbox if existing or unchecking otherwise
+ checkMode() = Set's *initCommand* and *label_info* based on current mode
  - Gets effective user of running application
  - If root and not in test mode, *initCommand* = "systemctl" and *label_info* = cleared ("")
  - Else, if in test mode, *initCommand* = "echo systemctl" and *label_info* = Test mode info
  - Else, *initCommand* = "echo systemctl" and *label_info* = ReadOnly mode info
  - Send *effectiveUser* and *initCommand* to qDebug
+ setTestMode(int testMode) = Takes [0,1,3] and sets mode accordingly
  - Sets *testStatus* = *testMode*
  - Sends passed *testMode* option to qDebug
  - Sets *testPath*
  - If *testMode* = "1" (On)
    - Create directory specified by *testPath*
    - Create "speed", "sensitivity", and "press_to_select" files in *testPath* with contents "Test"
    - Run **setSettingsPath()**, **setPersistPaths()**, **displaySettings()**, and **checkMode()**
  - If *testMode* = "0" (Off)
    - Recursively remove test directory (*testPath*)
    - Run **setSettingsPath()**, **setPersistPaths()**, **displaySettings()**, and **checkMode()**
  - If *testMode* = "3" (Cleanup).  This is used to remove all testing files but without run other functions that will cause a segmentation fault if run at application exit
    - Recursively remove test directory (*testPath*).  
+ on_button_Apply_clicked() = Applies any specified settings
  - Runs **applySettings(<settingsFile>, <ui_settings_edit>)** for all three settings (blank or NULL values are handled within called function)
  - Runs **displaySettings()**
  - If the persistence checkbox is checked, runs **installTrackpointSH()**
  - Clears all values in the text edit boxes
+ on_button_Defaults_clicked() = Sets TrackPoint settings to default values
  - Sets "speed" to "97"
  - Sets "sensitivity" to "128"
  - Sets "press_to_select" to "0"
  - Runs **displaySettings()**
  - If persist checkbox is checked, runs **installTrackpointSH()**
+ on_check_Persist_clicked() = Toggles settings persistence
  - If checkbox is checked when it's clicked...
     - If *trackpointSHPath* is "N/A", critical alert user no initialization and uncheck checkbox
     - Else, run **installTrackpointSH()**, **installTrackpointService()**, **installTrackpointTimer()**, and run initialization commands to configure installed persistent settings
   - If checkbox is not checked when it's clicked...
     - If *trackpointSHPath* is "N/A", do nothing
     - Else...
       - Run initialization commands to to stop/disable persistent settings
       - Delete generated files for persistence
       - Run command to reload initialization system
       - Run **applySettings(<settingsFile>, <ui_settings_label>)** for all three settings to maintain current settings (defaults can be set by clicking "Defaults" button)
       - Run **displaySettings()**
+ on_actionToggle_Test_Mode_triggered = Toggles test mode
  - If "speed" file exist in *testPath*, run **setTestMode(0)**  (disable test mode)
  - Else, run **setTestMode(1)** (enable test mode)
+ installTrackpointSH() = Generates "trackpoint.sh" script for persistence configuration
+ installTrackpointService() = Generates "trackpoint.service" for persistence configuration
+ installTrackpointTimer() = Generates "trackpoint.timer" for persistence configuration

#### Variables (Local)
+ effectiveUser:auto = In **checkMode()**, stores uid of user who is running the application
+ testPath:= In **setTestMode()**, path used for storing all outputed files created by application when in Test mode
+ testMode: = In **setTestMode()**, stores option passed to function

#### Variables (Global)
+ settingPath:QString = Path to TrackPoint settings (e.x., "/sys/devices/platform/i8042/serio1/serio2")
+ trackpointSHPath:QString = Path for trackpoint.sh script (used for persistence configuration)
+ initPath:QString = Path for initialization system configurations (e.x., "/usr/bin").  Used for persistence configuration
+ initCommand:QString = Command for interaction with initialization system (e.x., "systemcdtl").  Used for persistence configuration
+ testPath:QString = Path for all generated files while in "Test" mode (e.x., "/tmp/pkf_trackpoint")
+ testStatus:int = Status for "Test Mode"
  - "0" = off
  - "1" = on
  - "3" = cleanup during application shutdown (similar to "0" but does not run other functions)

#### Process Flow
The main loop will...
1. Set the path for TrackPoint settings by running "setSettingsPath", which will...
  - If in "Test" mode **(see "Modes" above)**, set path to the testing directory "/tmp/pkf_trackpoint"
  - Otherwise, as long as a TrackPoint settings directory is detected (depends on existence of trackpad), set path appropriately
  - If no TrackPoint setting directory is detected, alerts user and exits program
1. Set the path for persistence files by running "setPersistPaths", which will...
  - If in "Test" mode **(see "Modes" above)**, set path to the testing directory "/tmp/pkf_trackpoint"
  - Otherwise, as long as an initialization system is detected (currently only supports systemd), set path appropriately
  - If no initialization setting directory is detected, sets path to "N/A", which will prevent the user from checking the "Enable Persistence" checkbox.
1. Check whether the user is root or not by running "checkUser", which will...
  - If effective user is root, sets initialization command to actual command (i.e., "systemctl" for systemd)
  -  If effective user is anyone other than root, sets initialization command with prefixed "echo" (i.e., "echo systemctl" for systemd) and displays text in Info label for the user to run as root or with sudo to make changes.
1. Set validators for the text input fields by running "validateSettings" which will...
  - Set the input text boxes for speed and sensitivity only accept values 1-255 (though user still permitted to enter "0")
  - Set the input text box for press_to_select to only accept values 0-1
1. Display the current TrackPoint settings by running "displaySettings", which will...
  - Read TrackPoint configuration settings and print them to the appropriate labels.
1. Check the "Enable Persistence" checkbox if it detects persistence has been enabled.

User can then...
1. Enter values into text boxes and click "Apply", which will...
  - Run "applySettings" for all three settings, passing in the appropriate settings path and text of respective text box, which will in turn apply the setting only if the text box was not empty.
  - Update the displayed values by running "displaySettings"
  - Run "installTrackpointSH" **(covered below in "Enable Persistence...")**, only if persistence is enabled, to apply changes made
  - Clear all text boxes.
1. Reset TrackPoint settings to defaults by clicking "Defaults", which will...
  - Run "applySettings" for all three settings, passing in the appropriate settings path and default value, which will in turn apply all settings to default values
  - Update the displayed values by running "displaySettings"
  - Run "installTrackpointSH" **(covered below in "Enable Persistence...")** only if persistence is enabled, to apply changes made   
1. Enable Persistence by checking the "Enable Persistence" which will...
  - If status is changing to "checked"...
    - If no initialization system is detected, alert user and un-checks the checkbox
    - Else, runs functions to create files for persistence, then executes commands to run and enable persistence via the initialization system
  - If status is changing to "unchecked"...
    - If no initialization system is detected, notification passed to console that nothing is changing.
    - Else, commands run to disable and stop persistence, then all files created for persistence are removed, then initialization is reloaded if required.
1. Toggle "Test" mode by clicking on "Advanced -> Toggle "Test" mode", which will...
  - If currently not in "Test" mode...
    - Create directory and files for test mode
    - Update information label that user is now in "Test" mode
    - Reruns "setSettingsPath", "setPersistPaths", "displaySettings", and "checkMode"
    - All interaction with application will be applied to files within the created "Test" directory
  - If currently in "Test" mode...
    - Recursively removes the "Test" directory and all it's contents
    - Updates information label to "ReadOnly" for regular users or "" for root user
    - Reruns "setSettingsPath", "setPersistPaths", "displaySettings", and "checkMode"
    - User is now in "ReadOnly" mode if regular user, or "Normal" if root user
